import React, { useEffect, useState, useMemo } from 'react';
import GlassCard from '../../components/ui/GlassCard';
import { supabase } from '../../lib/supabase';
import {
    BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,
    PieChart, Pie, Cell, AreaChart, Area, Legend
} from 'recharts';
import { format, parseISO } from 'date-fns';
import { ptBR } from 'date-fns/locale';

// Types
interface Brand {
    id: string;
    name: string;
}

interface Unit {
    id: string;
    name: string;
    brand_id: string;
}

interface Honoree {
    id: string;
    name: string;
    brand_id: string;
    unit_id: string;
    awarded_at: string;
    is_published: boolean;
}

const DashboardPage: React.FC = () => {
    const [isLoading, setIsLoading] = useState(true);
    const [brands, setBrands] = useState<Brand[]>([]);
    const [units, setUnits] = useState<Unit[]>([]);
    const [honorees, setHonorees] = useState<Honoree[]>([]);

    // Filters
    const [selectedBrandId, setSelectedBrandId] = useState<string>('all');
    const [selectedUnitId, setSelectedUnitId] = useState<string>('all');
    const [periodType, setPeriodType] = useState<'month' | 'semester' | 'year'>('year');

    useEffect(() => {
        fetchData();
    }, []);

    const fetchData = async () => {
        setIsLoading(true);
        try {
            const [brandsRes, unitsRes, honoreesRes] = await Promise.all([
                supabase.from('brands').select('*').order('name'),
                supabase.from('units').select('*').order('name'),
                supabase.from('honorees').select('id, professional_data, brand_id, unit_id, awarded_at, is_published')
            ]);

            setBrands(brandsRes.data || []);
            setUnits(unitsRes.data || []);

            const processedHonorees = (honoreesRes.data || []).map(h => {
                let profData: any = {};
                try {
                    if (typeof h.professional_data === 'string') {
                        profData = JSON.parse(h.professional_data);
                    } else if (h.professional_data && typeof h.professional_data === 'object') {
                        profData = h.professional_data;
                    }
                } catch (e) {
                    console.error('Error parsing professional_data:', e);
                }

                return {
                    id: h.id,
                    name: profData?.name || 'N/A',
                    brand_id: h.brand_id,
                    unit_id: h.unit_id,
                    awarded_at: h.awarded_at,
                    is_published: h.is_published || false
                };
            });
            setHonorees(processedHonorees);
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
        } finally {
            setIsLoading(false);
        }
    };

    // Filtered Data
    const filteredHonorees = useMemo(() => {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();

        return honorees.filter(h => {
            // Brand and Unit filters
            const matchesBrand = selectedBrandId === 'all' || h.brand_id === selectedBrandId;
            const matchesUnit = selectedUnitId === 'all' || h.unit_id === selectedUnitId;

            // Period filter
            let matchesPeriod = true;
            if (h.awarded_at) {
                const awardedDate = parseISO(h.awarded_at);
                const awardedYear = awardedDate.getFullYear();
                const awardedMonth = awardedDate.getMonth();

                if (periodType === 'month') {
                    // Current month
                    matchesPeriod = awardedYear === currentYear && awardedMonth === currentMonth;
                } else if (periodType === 'semester') {
                    // Current semester
                    const currentSemester = currentMonth < 6 ? 0 : 1;
                    const awardedSemester = awardedMonth < 6 ? 0 : 1;
                    matchesPeriod = awardedYear === currentYear && awardedSemester === currentSemester;
                } else if (periodType === 'year') {
                    // Current year
                    matchesPeriod = awardedYear === currentYear;
                }
            }

            return matchesBrand && matchesUnit && matchesPeriod;
        });
    }, [honorees, selectedBrandId, selectedUnitId, periodType]);

    // Metrics
    const metrics = useMemo(() => {
        const total = filteredHonorees.length;

        const byBrand = brands.map(b => ({
            name: b.name,
            count: filteredHonorees.filter(h => h.brand_id === b.id).length
        })).filter(b => b.count > 0);

        const byUnit = units.map(u => ({
            name: u.name,
            count: filteredHonorees.filter(h => h.unit_id === u.id).length
        })).filter(u => u.count > 0);

        const topBrand = [...byBrand].sort((a, b) => b.count - a.count)[0];
        const topUnit = [...byUnit].sort((a, b) => b.count - a.count)[0];

        return {
            total,
            byBrand,
            byUnit,
            topBrand,
            topUnit
        };
    }, [filteredHonorees, brands, units]);

    // Chart Data: Awards by Unit
    const unitChartData = useMemo(() => {
        return metrics.byUnit
            .sort((a, b) => b.count - a.count)
            .slice(0, 10);
    }, [metrics.byUnit]);

    // Chart Data: Awards by Brand
    const brandChartData = useMemo(() => {
        return metrics.byBrand.sort((a, b) => b.count - a.count);
    }, [metrics.byBrand]);

    // Chart Data: Timeline
    const timelineData = useMemo(() => {
        const groups: { [key: string]: number } = {};

        filteredHonorees.forEach(h => {
            const date = parseISO(h.awarded_at);
            let key = '';

            if (periodType === 'month') {
                key = format(date, 'MMM/yy', { locale: ptBR });
            } else if (periodType === 'semester') {
                const semester = date.getMonth() < 6 ? '1º Sem' : '2º Sem';
                key = `${semester} ${date.getFullYear()}`;
            } else {
                key = date.getFullYear().toString();
            }

            groups[key] = (groups[key] || 0) + 1;
        });

        return Object.entries(groups).map(([name, count]) => ({ name, count }));
    }, [filteredHonorees, periodType]);

    const handleExportJSON = () => {
        const data = {
            exportDate: new Date().toISOString(),
            metrics,
            honorees: filteredHonorees
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `dashboard-export-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    };

    const handleExportPDF = () => {
        window.print();
    };

    const COLORS = ['#D4AF37', '#C0C0C0', '#CD7F32', '#1A2B4B', '#2A4B8C'];

    if (isLoading) {
        return (
            <div className="flex justify-center py-20">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-gold"></div>
            </div>
        );
    }

    return (
        <div className="space-y-10 animate-fade-in pb-20 px-6 md:px-10 lg:px-16">
            {/* Header & Global Filters */}
            <div className="flex flex-wrap justify-between items-end gap-8 mb-6">
                <div className="space-y-4">
                    <h2 className="text-5xl font-bold font-serif text-off-white italic">Dashboard <span className="text-gold-gradient">Estratégico</span></h2>
                    <p className="text-off-white/40 max-w-2xl text-lg font-light italic">
                        Análise consolidada de mérito institucional e distribuição de láureas.
                    </p>
                </div>

                <div className="flex flex-wrap gap-4 bg-white/5 p-4 rounded-[2rem] border border-white/10 backdrop-blur-md">
                    <div className="flex flex-col gap-2">
                        <label className="text-[8px] font-bold text-gold uppercase tracking-widest ml-2">Marca</label>
                        <select
                            className="bg-navy-deep border border-white/10 text-off-white text-xs rounded-xl px-4 py-2 outline-none focus:border-gold/50"
                            value={selectedBrandId}
                            onChange={(e) => {
                                setSelectedBrandId(e.target.value);
                                setSelectedUnitId('all');
                            }}
                        >
                            <option value="all">Todas as Marcas</option>
                            {brands.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                        </select>
                    </div>

                    <div className="flex flex-col gap-2">
                        <label className="text-[8px] font-bold text-gold uppercase tracking-widest ml-2">Unidade</label>
                        <select
                            className="bg-navy-deep border border-white/10 text-off-white text-xs rounded-xl px-4 py-2 outline-none focus:border-gold/50 disabled:opacity-30"
                            value={selectedUnitId}
                            onChange={(e) => setSelectedUnitId(e.target.value)}
                            disabled={selectedBrandId === 'all'}
                        >
                            <option value="all">Todas as Unidades</option>
                            {units.filter(u => u.brand_id === selectedBrandId).map(u => (
                                <option key={u.id} value={u.id}>{u.name}</option>
                            ))}
                        </select>
                    </div>

                    <div className="flex flex-col gap-2">
                        <label className="text-[8px] font-bold text-gold uppercase tracking-widest ml-2">Período</label>
                        <div className="flex bg-navy-deep rounded-xl border border-white/10 p-1">
                            {(['month', 'semester', 'year'] as const).map(p => (
                                <button
                                    key={p}
                                    onClick={() => setPeriodType(p)}
                                    className={`px-3 py-1 rounded-lg text-[9px] font-bold uppercase tracking-tighter transition-all ${periodType === p ? 'bg-gold text-navy-deep' : 'text-off-white/40 hover:text-off-white'}`}
                                >
                                    {p === 'month' ? 'Mês' : p === 'semester' ? 'Sem' : 'Ano'}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            </div>

            {/* Empty State */}
            {filteredHonorees.length === 0 ? (
                <GlassCard className="p-20 rounded-[3rem] border-white/5 text-center">
                    <div className="max-w-md mx-auto space-y-6">
                        <div className="size-24 mx-auto rounded-full bg-gold/5 flex items-center justify-center">
                            <span className="material-symbols-outlined text-5xl text-gold/30">analytics</span>
                        </div>
                        <h3 className="text-2xl font-serif italic text-off-white">Nenhum Dado Disponível</h3>
                        <p className="text-off-white/40 max-w-sm mx-auto">
                            {honorees.length === 0
                                ? "Nenhuma premiação foi cadastrada ainda. Comece cadastrando marcas, unidades e homenageados para visualizar os dados."
                                : "Nenhum resultado encontrado para os filtros selecionados. Tente ajustar marca, unidade ou período."}
                        </p>
                        <div className="flex gap-4 justify-center pt-4">
                            <button
                                onClick={() => window.location.href = '/admin/marcas'}
                                className="px-6 py-3 rounded-xl bg-white/5 border border-white/10 text-off-white hover:border-gold/30 transition-all text-sm font-medium"
                            >
                                Gerenciar Marcas
                            </button>
                            <button
                                onClick={() => window.location.href = '/admin/homenageados/novo'}
                                className="px-6 py-3 rounded-xl bg-gold text-navy-deep hover:bg-gold-light transition-all text-sm font-bold"
                            >
                                Cadastrar Premiação
                            </button>
                        </div>
                    </div>
                </GlassCard>
            ) : (
                <>
                    {/* KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                        <GlassCard className="p-8 rounded-3xl border-white/5 bg-gradient-to-br from-gold/10 to-transparent">
                            <p className="text-[9px] font-bold text-off-white/40 uppercase tracking-[0.2em] mb-4">Total de Premiações</p>
                            <div className="flex items-end gap-3">
                                <span className="text-4xl font-bold font-serif text-off-white italic">{metrics.total}</span>
                                <span className="material-symbols-outlined text-gold mb-1">military_tech</span>
                            </div>
                        </GlassCard>

                        <GlassCard className="p-8 rounded-3xl border-white/5">
                            <p className="text-[9px] font-bold text-off-white/40 uppercase tracking-[0.2em] mb-4">Marcas Ativas</p>
                            <div className="flex items-end gap-3">
                                <span className="text-4xl font-bold font-serif text-off-white italic">{metrics.byBrand.length}</span>
                                <span className="material-symbols-outlined text-gold/50 mb-1">hub</span>
                            </div>
                        </GlassCard>

                        <GlassCard className="p-8 rounded-3xl border-white/5">
                            <p className="text-[9px] font-bold text-off-white/40 uppercase tracking-[0.2em] mb-4">Unidades Premiadas</p>
                            <div className="flex items-end gap-3">
                                <span className="text-4xl font-bold font-serif text-off-white italic">{metrics.byUnit.length}</span>
                                <span className="material-symbols-outlined text-gold/50 mb-1">location_city</span>
                            </div>
                        </GlassCard>

                        <GlassCard className="p-8 rounded-3xl border-white/5 border-gold/20 bg-gold/5">
                            <p className="text-[9px] font-bold text-gold uppercase tracking-[0.2em] mb-4">Top Marca</p>
                            <div className="space-y-1">
                                <p className="text-xl font-bold text-off-white truncate">{metrics.topBrand?.name || 'N/A'}</p>
                                <p className="text-[10px] text-gold/60 uppercase tracking-widest">{metrics.topBrand?.count || 0} prêmios</p>
                            </div>
                        </GlassCard>

                        <GlassCard className="p-8 rounded-3xl border-white/5 border-gold/20 bg-gold/5">
                            <p className="text-[9px] font-bold text-gold uppercase tracking-[0.2em] mb-4">Top Unidade</p>
                            <div className="space-y-1">
                                <p className="text-xl font-bold text-off-white truncate">{metrics.topUnit?.name || 'N/A'}</p>
                                <p className="text-[10px] text-gold/60 uppercase tracking-widest">{metrics.topUnit?.count || 0} prêmios</p>
                            </div>
                        </GlassCard>
                    </div>

                    {/* Charts Row 1 */}
                                <button className="text-gold text-[9px] font-bold uppercase tracking-widest hover:opacity-70 transition-opacity">Ver Tudo</button>
                            </div>
                            <div className="space-y-4">
                                {metrics.byUnit.length > 0 ? (
                                    metrics.byUnit.sort((a, b) => b.count - a.count).slice(0, 5).map((unit, i) => (
                                        <div key={i} className="flex items-center justify-between p-5 rounded-2xl bg-white/[0.02] border border-white/5 group hover:border-gold/30 transition-all">
                                            <div className="flex items-center gap-6">
                                                <span className="text-2xl font-serif italic text-gold/20 group-hover:text-gold transition-colors">#{(i + 1).toString().padStart(2, '0')}</span>
                                                <div>
                                                    <p className="text-off-white font-medium">{unit.name}</p>
                                                    <p className="text-[10px] text-off-white/20 uppercase tracking-widest">Excelência Institucional</p>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xl font-bold text-gold">{unit.count}</p>
                                                <p className="text-[9px] text-off-white/20 uppercase tracking-tighter">Prêmios</p>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center py-10">
                                        <p className="text-off-white/30 text-sm italic">Nenhuma unidade premiada no período selecionado</p>
                                    </div>
                                )}
                            </div>
                        </GlassCard>

                        <GlassCard className="p-10 rounded-[3rem] border-white/5 bg-gradient-to-br from-gold/5 to-transparent flex flex-col justify-between">
                            <div className="space-y-6">
                                <div className="size-16 rounded-2xl bg-gold/10 flex items-center justify-center text-gold mb-8">
                                    <span className="material-symbols-outlined text-3xl">ios_share</span>
                                </div>
                                <h3 className="text-2xl font-serif italic text-off-white">Exportação Executiva</h3>
                                <p className="text-off-white/40 text-sm leading-relaxed">
                                    Gere relatórios consolidados em PDF ou Excel para apresentações e reuniões de conselho.
                                </p>
                            </div>

                            <div className="space-y-4 mt-10">
                                <button
                                    onClick={handleExportPDF}
                                    className="w-full bg-gold text-navy-deep py-4 rounded-2xl font-bold text-[10px] uppercase tracking-[0.3em] hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-3"
                                >
                                    <span className="material-symbols-outlined text-lg">picture_as_pdf</span>
                                    Exportar PDF
                                </button>
                                <button
                                    onClick={handleExportJSON}
                                    className="w-full bg-white/5 text-off-white/60 py-4 rounded-2xl font-bold text-[10px] uppercase tracking-[0.3em] hover:bg-white/10 hover:text-off-white transition-all flex items-center justify-center gap-3 border border-white/10"
                                >
                                    <span className="material-symbols-outlined text-lg">database</span>
                                    Exportar JSON
                                </button>
                            </div>
                        </GlassCard>
                    </div >
                </>
            )}
        </div >
    );
};

export default DashboardPage;
